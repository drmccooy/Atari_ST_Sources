ZORG, Copyright Ludovic Rousseau 1993, 1994



                             BOOT



  Chaque disquette ou partition possŠde ce que l'on appelle un boot sector. Ce
secteur renferme les caract‚ristiques de la disquette ou de la partition
(nombre de faces, de pistes...) et peut renfermer un petit programme le cas
‚ch‚ant (un virus, un anti-virus, un chargeur de jeu ou autre).


Le boot sector contient les champs suivants :

Octet Taille Label
  $00   2      BRA.S  branch to boot code
  $02   6      OEM
  $08   3      SERIAL num‚ro de s‚rie
  $0B   2      BPS    nombre d'octets par secteur
  $0D   2      SPC    nombre de secteurs par bloc
  $0E   2      RES    nombre de secteurs r‚serv‚s
  $10   1      NFATS  nombre de FATs
  $11   2      NDIRS  nombre d'entr‚es … la racine
  $13   2      NSECTS nombre de secteurs
  $15   1      MEDIA  descripteur de MEDIA
  $16   2      SPF    nombre de secteurs par FAT
  $18   2      SPT    nombre de secteurs par piste
  $1A   2      NSIDES nombre de faces
  $1C   1      NHID   nombre de secteurs cach‚s

  $1D   1      ???

  $1E   2      EXECFLG
  $20   2      LDMODE
  $22   2      SSECT
  $24   2      SECTCNT
  $26   4      LDADDR
  $2A   4      FATBUF
  $2E   11     FNAME

  $39   1      r‚serv‚

  $3A   1C4    code assembleur le cas ‚ch‚ant

  $1FE  2      CheckSum


  Si le mot de poids faible de la somme des 256 mots du secteur est ‚gal …
$1234 alors le secteur est ex‚cutable. Lors du d‚marrage de l'ordinateur
(boot), le systŠme charge le secteur et effectue un JSR sur le premier octet du
secteur. Pour cette raison la premiŠre instruction du boot sector est une
instruction de branchement inconditionnel sur le code effectif qui se trouve un
peu plus loin dans le secteur (BRA.S $3A(PC) en g‚n‚ral). Le secteur n'est pas
charg‚ … une adresse fixe en m‚moire, pour cette raison le code ex‚cut‚ ne doit
pas utiliser l'adressage absolu mais seulement l'adressage relatif au compteur
de programme (PC).


L'OEM (Other Enterprise Manufactoring) n'est pas utilis‚ par le systŠme. Il
sert simplement de signature. Par exemple il indique le nom du programme qui a
format‚ le disque.

Le num‚ro de s‚rie (SERIAL) est trŠs important. Il permet au systŠme de
diff‚rencier les disques. Si deux disquettes ont le mˆme num‚ro de s‚rie, le
systŠme ne se rendra compte de rien lors d'un changement de disquette et ne
remettra pas sa copie de la FAT … jour. Il utilisera l'ancienne FAT avec le
nouveau disque croyant que c'est encore l'ancien. Ce n'est pas trop grave si on
ne fait que lire le disque mais c'est catastrophique si on ‚crit dessus, le
systŠme ‚crivant l'ancienne FAT sur le nouveau disque. J'ai perdu beaucoup de
disques … cause de cela en utilisant un formateur qui mettait toujours le mˆme
num‚ro de s‚rie.

BPS (Bytes Per Sector) donne le nombre d'octets par secteur. Normallement il y
a 512 octets par secteur. ZORG ne sait pas g‚rer des secteurs ayant une taille
diff‚rente de 512 octets.

SPC (Sectors Per Cluster) donne le nombre de secteurs que contient un bloc. La
gestion du disque se fait par blocs (voir FAT.TXT). Un bloc occupe en g‚n‚ral 2
secteurs.


RES (REServed) donne le nombre de secteurs r‚serv‚s. Ce nombre est ‚gal … 1
g‚n‚ralement. Peut-ˆtre prend-t-il en compte le boot sector.

NFATS (Number of FATs) vaut 2. La deuxiŠme FAT sert … pouvoir quand mˆme
r‚cup‚rer le disque si la premiŠre FAT a un problŠme de lisibilit‚.

NDIRS (Number of DIRectoryS). Contrairement … un dossier, la taille du
r‚pertoire principal est fixe (voir DISK.TXT). NDIRS donne le nombre de
fichiers ou dossiers que la disquette peut supporter … la racine. Ce champ vaut
112 sur une disquette 'normale' ce qui est souvent largement suffisant.

NSECTS (Number of SECTorS) donne le nombre total de secteurs sur la disquette.
Il vaut Sects * Pistes * Faces si Sects est le nombre de secteurs par piste,
Pistes le nombre de pistes et Faces le nombre de faces.

MEDIA n'est pas utilis‚ par le systŠme.

SPF (Sectors Per FAT) est la taille de la FAT en secteur. Cette taille d‚pend
du nombre de blocs donc de secteurs sur la disquette. Chaque bloc occupe 1.5
octet dans la FAT (2 pour un disque dur). Il faut que la FAT ait une taille en
rapport avec le nombre de blocs pour pouvoir tous les contenir.

SPT (Sectors Per Track) est le nombre de secteurs par piste. Il vaut 9 pour une
disquette 'normale'. On peut facilement et sans aucun problŠme utiliser des
disquettes avec 10 secteurs par pistes. L'appel systŠme XBIOS de formatage
(Flopfmt) supporte 10 secteurs par piste. Certains programmes permettent de
monter jusqu'… 11 secteurs par piste (comme sur Amiga) mais … ce niveau de
densit‚ les secteurs se suivent de trŠs prŠs et la lecture de la disquette est
fortement ralentie. Je ne vous conseille pas d'utiliser des disquettes de plus
de 10 secteurs. Les nouvelles machines Atari ont des lecteurs haute densit‚ qui
permettent de doubler le nombre de secteurs par piste. 18 secteurs par piste
est alors la valeur 'normale'.

NSIDES (Number of SIDES) donne le nombre de faces de la disquette. Il peut
th‚oriquement y avoir un maximum de 65535 faces car le champ est sur 16 bits. 8
bits auraient largement suffit … mon avis, surtout que ce champ n'est pas
utilis‚ pour une partition de disque dur et donc n'ira jamais au-del… de 2 (il
existe des disquettes … 3 faces ?).

NHID (Number of HIDden sectors) n'est pas utilis‚ par le systŠme.

  Quelquefois, le boot sector est 'Loader', ce qui veut dire qu'il contient des
informations permettant au systŠme de charger un fichier ou des secteurs …
partir de la disquette. Cette possibilit‚ est, entre autres, utilis‚e par les
disquettes contenant un systŠme utilis‚ aux d‚buts du ST lorsque le systŠme
n'‚tait pas encore en ROM et qu'il fallait le charger … partir d'une disquette.
Dans ce cas le boot sector contenait des informations pour charger le fichier
TOS.IMG. Pour qu'un boot sector ait ces propri‚t‚s, il faut que l'OEM soit ‚gal
… la chaŒne ASCII 'Loader'.

EXECFLG (EXEC FLaG) est copi‚ dans la variable systŠme _cmdload en $482.

LDMODE (LoaD MODE) indique le mode de chargement. Si LDMODE est nul le fichier
FNAME est recherch‚ sinon les secteurs indiqu‚s sont charg‚s.

SSECT (Start SECTor) indique le secteur de d‚part.

SECTCNT (SECTor CouNT) donne le nombre de secteurs … charger.

LDADDR (LoaD ADDRess) est l'adresse o— sont charg‚s les secteurs.

FATBUF (FAT BUFfer) est l'adresse … utiliser pour la FAT.

FNAME (File NAME) est le nom du fichier … charger. Ce nom est compos‚ de 8
caractŠres plus une extension de 3 caractŠres.

  Vient  ensuite, s'il existe, le code assembleur du boot sector.
