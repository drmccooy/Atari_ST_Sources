ZORG, Copyright Ludovic Rousseau 1993, 1994



                             HARD DISK BOOT



  Les disquettes et les partitions de disque dur ont un boot sector. Ce boot
sector donne des informations sur le format de la disquette ou de la partition.
Sur un disque dur il y un 'super boot sector' qui donne des informations non
pas pour une seule partition mais pour le disque dur entier.
  Ce super boot sector se trouve comme d'habitude sur le secteur 0 du disque.
Il ne faut pas confondre le secteur 0 de la premiŠre partition et le secteur 0
du disque. Le secteur 0 de la premiŠre partition est en fait le secteur 2 (en
tout cas chez moi) du disque.
  On peut lire ou ‚crire ce super boot sector avec les entr‚es 'Lire' et
'Ecrire' du menu 'Informations' ou avec un accŠs direct au disque.


  Il se d‚compose en :

    Octet Taille Label

    $1B6  1      hd_cc     nombre de cylindres
    $1B8  1      hd_dhc    nombre de tˆtes
    $1B9  1      hd_unused inutilis‚
    $1BA  2      hd_rwcc   reduce write current cylinder
    $1BC  2      hd_wpc    write precomp cylinder
    $1BE  1      hd_lz     landing zone
    $1BF  1      hd_rt     seek rate code
    $1C0  1      hd_in     interleave factor
    $1C1  1      hd_spt    sectors per track
    $1C2  4      hd_siz    taille totale du disque en secteurs

    $1C6  1      p0_flg    la partition 0 existe si pf_flg>0
                           si le bit 7 est positionn‚, le bootage se fait ici
    $1C7  3      p0_id     identificateur de la partition
    $1CA  4      p0_st     num‚ro de secteur du premier secteur de la
partition

    $1CE  4      p0_siz    taille de la partition en secteurs

    $1D2  1      p1_flg    idem, pour la partition 1
    $1D3  3      p1_id
    $1D6  4      p1_st
    $1DA  4      p1_siz

    $1DE  1      p2_flg    idem, pour la partition 2
    $1DF  3      p2_id
    $1E2  4      p2_st
    $1E6  4      p2_siz

    $1EA  1      p3_flg    idem, pour la partition 3
    $1EB  3      p3_id
    $1EE  4      p3_st
    $1F2  4      p3_siz

    $1F6  4      bsl_st    secteur de d‚part de la "bad sector list"
    $1FA  4      bsl_cnt   taille en secteurs de la liste


  Ces renseignements proviennent du livre 'Disquette et Disque Dur'. Ce livre
date de 1986 et … l'‚poque les disques de plus de 4 partitions ne devaient pas
exister.

  Avec AHDI 5 et 6, les disque de plus de 4 partitions sont g‚r‚s de la fa‡on
suivante:

  il n'y a de toute fa‡on pas de place pour mettre la description des
partitions supl‚mentaires dans le boot sector. Une des quatres partitions a
alors l'identification XGM au lieu de GEM pour une partition normale.
  Cette partition XGM regroupe plusieurs partitions (GEM et/ou XGM). Le premier
secteur et la taille d'une partition ‚tant donn‚s sur 32 bits, une partiton XGM
peut aller jusqu'… plus de 4 miliards de secteur et donc renfermer pas mal de
partitions. Le premier secteur d'une partiton XGM joue le mˆme r“le qu'un
'super boot sector'. Le secteur contient une description de 4 nouvelles
partitions. Celle-ci pouvant ˆtre GEM ou XGM. Les secteurs de d‚part des
sous-partitions sont relatifs … la partition XGM les contenant. Par exemple la
premiŠre sous-partition commence au secteur 1 alors que son premier secteur
r‚el est en fait 1+premier secteur de la partition XGM.
  Cette astuce permet de ne plus ˆtre limit‚ … quatres partitions. La prochaine
limite est le nombre de descripteur possible pour les partitions. AHDI permet
de g‚rer un maximum de 16 partitions et le GEMDOS en suporte trŠs bien jusqu'…
32.

  Il existe aussi une autre vari‚t‚ de partition mutante dont l'identification
est BGM. Ce type de partition est utilis‚ pour les partitions de plus de 16 Mo.
En effet une telle partition ne peut plus utiliser des secteurs de 512 octets
car le num‚ro de secteur doit tenir sur 15 bits. Les secteurs sont alors plus
grand 1024 octets jusqu'… 16384 octets ce qui permet d'avoir des partition
jusqu'… 512 Mo. La taille de la partion est donn‚e en secteur de 512 octets. En
fait en utilisant DMAread() et DMAwrite(), on travaille toujours avec des
secteurs de 512 octets, ces appels systŠme num‚rotent les secteurs sur 32 bits.
Il est donc toujours possible d'acc‚der … n'importe quelle partition en passant
par un accŠs disque bas niveau et des secteurs de 512 octets.

  La 'bad sector list' est inscrite sur le disque lors du formatage. Elle
contient la liste de secteurs d‚fectueux qui n'ont pas pu ˆtre format‚s. Le
livre nous dit que le tableau se trouve la plupart du temps … la fin du disque
mais elle se trouve sur le secteur 2 de mon disque. Les secteurs marqu‚s dans
la liste sont toujours utilis‚s au sens o— ils apparaissent dans la FAT et
peuvent ˆtre lus, peut-ˆtre avec une erreur mais on peut au moins essayer.

octets. En

  Avec la variable pi_flg, le systŠme d'exploitation se rend compte si la
partition existe (pi_flg diff‚rent de z‚ro). Le systŠme d'exploitation boote …
partir du premier boot secteur dont pi_flg a le bit 7 positionn‚.
